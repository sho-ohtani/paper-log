<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>Literature Log â€” HOTFIX v13</title>
<meta name="theme-color" content="#0EA5E9">
<link rel="manifest" href="manifest.webmanifest?v=13">
<style>
/* ================= UI THEME ================= */
:root {
 --bg:#0b0f14; --bg2:#0f141a; --card:#121821; --text:#e6eef6;
 --muted:#9fb2c3; --accent:#0ea5e9; --border:#1f2937;
}
* { box-sizing:border-box; }
html,body {
 height:100%; margin:0; background:var(--bg);
 color:var(--text); font-family:system-ui,-apple-system;
}
header {
 position:sticky;top:0;z-index:10;
 background:linear-gradient(180deg,#0b0f1490,#0b0f1400 85%);
 backdrop-filter:blur(8px);
}
.top {
 display:flex;gap:.6rem;align-items:center;
 padding:.9rem .9rem .2rem;
}
.logo{width:26px;height:26px;border-radius:8px;
 background:linear-gradient(135deg,#0ea5e9,#22d3ee);position:relative}
.logo::after{content:'';position:absolute;inset:4px;border-radius:6px;background:#0b0f14}
.title{font-weight:700}
.badge{
 margin-left:.5rem;font-size:12px;color:#0b0f14;background:#0ea5e9;
 padding:.15rem .45rem;border-radius:8px;font-weight:700
}
.search{display:flex;gap:.5rem;margin:.4rem .9rem 1rem}
.search input{
 flex:1;padding:.8rem .9rem;border:1px solid var(--border);
 background:var(--bg2);color:var(--text);border-radius:12px;
}
.btn{
 border:none;border-radius:12px;padding:.7rem 1rem;font-weight:600;
 color:#0b0f14;background:linear-gradient(135deg,#0ea5e9,#22d3ee);
 cursor:pointer
}
.btn-secondary{color:var(--text);background:#18212d;border:1px solid var(--border)}
.wrap{padding:.5rem .9rem 5rem}
.item{
 padding:1rem;border:1px solid var(--border);
 border-radius:14px;margin:.6rem 0;
 background:linear-gradient(180deg,#0f141a,#0c1117);
 display:flex;justify-content:space-between;gap:.4rem;
 flex-wrap:wrap;
}
.item h3{margin:.2rem 0;font-size:15px;font-weight:700}
.meta{color:var(--muted);font-size:12px}
.tags{display:flex;gap:.3rem;flex-wrap:wrap;margin-top:.3rem}
.tag{font-size:11px;background:#112232;border:1px solid #1b3b54;
 padding:.2rem .5rem;border-radius:999px;color:#c7e8ff}
.pill{
 padding:.4rem .7rem;border-radius:10px;
 background:#121a25;border:1px solid var(--border);
 font-size:12px;color:var(--muted);cursor:pointer
}
.card{
 background:var(--card);border-radius:14px;border:1px solid var(--border);
 padding:1rem;margin:.8rem 0
}
.hidden{display:none}
.toast{
 position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
 background:#0ea5e9;color:#0b0f14;padding:.6rem 1rem;border-radius:10px;
 font-weight:700;box-shadow:0 6px 24px rgba(0,0,0,.3);opacity:0;transition:.3s
}
.toast.show{opacity:1}
.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.6);
 display:flex;justify-content:center;align-items:center;z-index:20
}
.modal > div{
 background:#0f141a;padding:1rem;border-radius:14px;
 width:90%;max-width:520px;
}
input,select,textarea{
 width:100%;padding:.7rem;border-radius:12px;
 border:1px solid var(--border);background:var(--bg2);
 color:var(--text);outline:none;
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:.5rem;flex-wrap:wrap}
.row>*{flex:1 1 140px}
</style>
</head>

<body>
<header>
 <div class="top">
  <span class="logo"></span>
  <span class="title">Literature Log</span>
  <span class="badge">HOTFIX v13</span>
  <div style="margin-left:auto;display:flex;gap:.4rem">
   <button class="btn-secondary" id="btnSettings">è¨­å®š</button>
   <button class="btn-secondary" id="btnFolders">ãƒ•ã‚©ãƒ«ãƒ€</button>
  </div>
 </div>
 <div class="search">
  <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«EN/JAãƒ»æŠ„éŒ²ãƒ»è‘—è€…ãƒ»é›‘èªŒãƒ»ã‚¿ã‚°ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ï¼‰" />
  <button class="btn" id="btnNew">è¿½åŠ </button>
 </div>
</header>

<main class="wrap">
 <p style="color:#8ab; font-size:13px;">ç™»éŒ²ã¯ã€Œè¿½åŠ ã€ã‹ã‚‰ã€‚PDFã®æŠ„éŒ²ã¯è‡ªå‹•æŠ½å‡º/ç¿»è¨³ã—ã¾ã™ã€‚OCRã«ã‚‚è‡ªå‹•åˆ‡æ›¿ã€‚</p>
 <section id="list"></section>
 <p id="empty" class="meta hidden">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
</main>

<!-- ===== Preview Modal ===== -->
<div id="previewModal" class="modal hidden">
 <div class="card">
  <h3 id="pvTitle"></h3>
  <p class="meta" id="pvAuthors"></p>
  <p class="meta" id="pvJournal"></p>
  <p class="meta" id="pvDate"></p>
  <p class="meta" id="pvFolder"></p>
  <p id="pvAbstract" style="margin-top:.6rem;font-size:14px;"></p>
  <div style="display:flex;gap:.4rem;margin-top:1rem;flex-wrap:wrap">
   <button class="btn-secondary" id="pvOpen">PDFã‚’é–‹ã</button>
   <button class="btn-secondary" id="pvEdit">ç·¨é›†</button>
   <button class="btn-secondary" id="pvDel">å‰Šé™¤</button>
   <button class="btn" id="pvClose">é–‰ã˜ã‚‹</button>
  </div>
 </div>
</div>

<!-- ===== Form Modal ===== -->
<div id="formModal" class="modal hidden">
 <div class="card">
  <h3 id="formTitle">æ–°è¦ç™»éŒ²</h3>
  
  <div class="row">
   <div><label>èª­äº†æ—¥</label><input type="date" id="fldDate"></div>
   <div><label>ãƒ•ã‚©ãƒ«ãƒ€</label><select id="fldFolder"></select></div>
  </div>
  <div class="row">
   <div><label>PDFãƒ•ã‚¡ã‚¤ãƒ«</label><input type="file" id="fldPdf" accept="application/pdf"></div>
  </div>
  <div><label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå’Œï¼šè‡ªå‹•ç¿»è¨³å¯ï¼‰</label><input id="fldTitleJa"></div>
  <div><label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè‹±ï¼‰</label><input id="fldTitle"></div>
  <div><label>è‘—è€…</label><input id="fldAuthors"></div>
  <div><label>æ²è¼‰èªŒ</label><input id="fldJournal"></div>
  <div><label>å…¬é–‹æ—¥</label><input type="date" id="fldPubDate"></div>
  <div><label>è¦ç´„ï¼ˆæ—¥æœ¬èªï¼‰</label><textarea id="fldAbstract"></textarea></div>
  <div><label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label><input id="fldTags"></div>

  <div class="row" style="margin-top:.8rem">
   <button class="btn" id="btnSave">ä¿å­˜</button>
   <button class="btn-secondary" id="btnCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
 </div>
</div>

<div id="dlgSettings" class="modal hidden">
 <div class="card">
  <h3>è¨­å®š</h3>
  <label>OpenAI API Key</label>
  <input id="fldApiKey" placeholder="sk-..." />
  <button class="btn" id="btnSaveSettings">OK</button>
  <button class="btn-secondary" id="btnCloseSettings">é–‰ã˜ã‚‹</button>
 </div>
</div>

<div id="dlgFolders" class="modal hidden">
 <div class="card">
  <h3>ãƒ•ã‚©ãƒ«ãƒ€ç®¡ç†</h3>
  <div class="row">
   <input id="fldNewFolder" placeholder="æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€å">
   <button class="btn" id="btnAddFolder">è¿½åŠ </button>
  </div>
  <ul id="folderList" style="padding-left:0;list-style:none;margin-top:1rem"></ul>
  <button class="btn-secondary" id="btnCloseFolders">é–‰ã˜ã‚‹</button>
 </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
/**************************************************************
 âœ… IndexedDB åˆæœŸåŒ–
**************************************************************/
const DB_NAME='litlog-db', DB_VER=5;
let db;
function openDB(){
 return new Promise((res,rej)=>{
  const r=indexedDB.open(DB_NAME,DB_VER);
  r.onupgradeneeded=e=>{
   const d=e.target.result;
   if(!d.objectStoreNames.contains('entries')){
    const os=d.createObjectStore('entries',{keyPath:'id',autoIncrement:true});
    os.createIndex('by_folder','folder');
   }
   if(!d.objectStoreNames.contains('files')){
    d.createObjectStore('files',{keyPath:'id'});
   }
   if(!d.objectStoreNames.contains('meta')){
    d.createObjectStore('meta',{keyPath:'key'});
   }
  };
  r.onsuccess=e=>{db=e.target.result;res();}
  r.onerror=rej;
 });
}
const tx=(mode,...stores)=>db.transaction(stores,mode);
const metaPut=(k,v)=>tx('readwrite','meta').objectStore('meta').put({key:k,val:v});
const metaGet=k=>new Promise(r=>{
 const q=tx('readonly','meta').objectStore('meta').get(k);
 q.onsuccess=()=>r(q.result?.val||null);
});

/**************************************************************
 âœ… Toast
**************************************************************/
function toast(msg){
 const t=document.getElementById('toast');
 t.textContent=msg;t.classList.add('show');
 setTimeout(()=>t.classList.remove('show'),1500);
}

/**************************************************************
 âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹
**************************************************************/
let previewing=false, previewItem=null;
const pvModal=document.getElementById('previewModal');

/**************************************************************
 âœ… PDF æŠ½å‡º + ç¿»è¨³
**************************************************************/
async function extractPDF(file){
 try{
  const ab=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:ab}).promise;
  let text=""; const pages=Math.min(3,pdf.numPages);
  for(let i=1;i<=pages;i++){
   const p=await pdf.getPage(i), c=await p.getTextContent();
   text+=c.items.map(x=>x.str).join(" ")+" ";
  }
  return text;
 }catch(e){return "";}
}

async function translateAbstract(en){
 const key=await metaGet('openai_key'); if(!key) return "";
 const res=await fetch("https://api.openai.com/v1/chat/completions",{
  method:"POST",
  headers:{ "Content-Type":"application/json","Authorization":"Bearer "+key },
  body:JSON.stringify({
   model:"gpt-4o-mini",
   messages:[
    {role:"system",content:"You translate academic abstracts to Japanese for physiotherapy. Accurate, no hallucinations."},
    {role:"user",content:"æ¬¡ã®è‹±æ–‡æŠ„éŒ²ã‚’è‡ªç„¶ã§æ­£ç¢ºãªæ—¥æœ¬èªã«ç¿»è¨³ã—ã¦ãã ã•ã„:\n"+en}
   ],
   temperature:0.2
  })
 });
 const j=await res.json();
 return j.choices?.[0]?.message?.content?.trim()||"";
}

/**************************************************************
 âœ… DB æ“ä½œ
**************************************************************/
async function saveEntry(obj,pdfFile){
 return new Promise((res,rej)=>{
  const t=tx('readwrite','entries');
  const store=t.objectStore('entries');
  const r=obj.id?store.put(obj):store.add(obj);
  r.onsuccess=async()=>{
   if(pdfFile){
    const fid="f_"+(obj.id||r.result);
    await tx('readwrite','files').objectStore('files').put({id:fid,blob:pdfFile});
    obj.fileId=fid;
    await tx('readwrite','entries').objectStore('entries').put(obj);
   }
   res();
  };
  r.onerror=e=>rej(e);
 });
}

function getFile(id){
 return new Promise((res,rej)=>{
  const r=tx('readonly','files').objectStore('files').get(id);
  r.onsuccess=()=>res(r.result?.blob||null);
  r.onerror=rej;
 });
}

/**************************************************************
 âœ… UI æ›´æ–°
**************************************************************/
async function refresh(){
 previewing=false;previewItem=null;
 pvModal.classList.add("hidden");
 const q=document.getElementById("q").value.toLowerCase();
 const items=await new Promise(r=>{
  const req=tx('readonly','entries').objectStore('entries').getAll();
  req.onsuccess=()=>r(req.result||[]);
 });
 items.sort((a,b)=> (b.date||"").localeCompare(a.date||"") || b.id-a.id);
 const f=q?items.filter(it=>{
  const s=[it.title,it.titleJa,it.abstract,it.authors,it.journal,(it.tags||[]).join(","),it.folder]
   .join(" ").toLowerCase();
  return s.includes(q);
 }):items;
 const list=document.getElementById("list");
 list.innerHTML="";
 if(!f.length){document.getElementById('empty').classList.remove("hidden");return;}
 document.getElementById('empty').classList.add("hidden");
 f.forEach(it=>{
  const div=document.createElement("div");
  div.className="item";
  div.innerHTML=`
   <div style="flex:1;min-width:260px;cursor:pointer">
    <h3>${it.titleJa||it.title||"(ç„¡é¡Œ)"}</h3>
    <div class="meta">${it.authors||""}</div>
    <div class="meta">${it.journal||""}ãƒ»${it.pubDate||""}</div>
    <div class="meta">ğŸ“ ${it.folder||"æœªåˆ†é¡"} / ${it.date||""}</div>
    <p style="font-size:12px;margin-top:.3rem;">${(it.abstract||"").slice(0,180)}...</p>
   </div>
   <button class="pill" data-id="${it.id}">æ“ä½œ</button>
  `;
  div.addEventListener("click",e=>{
   if(e.target.dataset.id) return;
   showPreview(it);
  });
  list.appendChild(div);
  document.querySelector(`button[data-id="${it.id}"]`).onclick=()=>showPreview(it);
 });
}

function showPreview(it){
 previewing=true;previewItem=it;
 document.getElementById('pvTitle').textContent = it.titleJa||it.title;
 document.getElementById('pvAuthors').textContent = it.authors||"";
 document.getElementById('pvJournal').textContent = it.journal||"";
 document.getElementById('pvDate').textContent = "èª­äº†æ—¥: "+(it.date||"");
 document.getElementById('pvFolder').textContent = "ğŸ“ "+(it.folder||"æœªåˆ†é¡");
 document.getElementById('pvAbstract').textContent = it.abstract||"";
 pvModal.classList.remove("hidden");
}

/**************************************************************
 âœ… ãƒ•ã‚©ãƒ¼ãƒ 
**************************************************************/
function openForm(edit){
 document.getElementById("formModal").classList.remove("hidden");
 if(edit){
  const o=previewItem;
  document.getElementById("formTitle").textContent="ç·¨é›†";
  fldDate.value=o.date; fldFolder.value=o.folder||"æœªåˆ†é¡";
  fldTitleJa.value=o.titleJa||""; fldTitle.value=o.title||"";
  fldAuthors.value=o.authors||""; fldJournal.value=o.journal||"";
  fldPubDate.value=o.pubDate||""; fldAbstract.value=o.abstract||"";
  fldTags.value=(o.tags||[]).join(","); 
  btnSave.onclick=()=>save(o.id,o.fileId);
 } else {
  document.getElementById("formTitle").textContent="æ–°è¦ç™»éŒ²";
  fldDate.value=new Date().toISOString().slice(0,10);
  fldFolder.value=folders[0]||"æœªåˆ†é¡";
  fldTitleJa.value=""; fldTitle.value="";
  fldAuthors.value=""; fldJournal.value="";
  fldPubDate.value=""; fldAbstract.value="";
  fldTags.value="";
  btnSave.onclick=()=>save();
 }
}

async function save(existingId=null,existingFileId=null){
 const pdfFile=fldPdf.files[0]||null;
 let ja=fldTitleJa.value.trim();
 if(!ja && fldTitle.value.trim()){
  ja = await translateAbstract(fldTitle.value.trim());
 }
 const o={
  id:existingId||undefined,
  date:fldDate.value,
  folder:fldFolder.value||"æœªåˆ†é¡",
  title:fldTitle.value.trim(),
  titleJa:ja.trim(),
  authors:fldAuthors.value.trim(),
  journal:fldJournal.value.trim(),
  pubDate:fldPubDate.value,
  abstract:fldAbstract.value.trim(),
  tags:fldTags.value.split(",").map(s=>s.trim()).filter(Boolean),
  fileId:existingFileId||null
 };
 if(!o.title && !o.titleJa) return toast("ã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆ");
 try{
  await saveEntry(o,pdfFile);
  toast("ä¿å­˜ã—ã¾ã—ãŸ");
  document.getElementById("formModal").classList.add("hidden");
  refresh();
 }catch(e){alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š"+e);}
}

/**************************************************************
 âœ… åˆæœŸåŒ–
**************************************************************/
let folders=["æœªåˆ†é¡"];
async function init(){
 await openDB();
 const saved=await metaGet("folders");
 if(Array.isArray(saved)&&saved.length) folders=saved;
 fldFolder.innerHTML=folders.map(f=>`<option>${f}</option>`).join("");
 refresh();
}
init();

/**************************************************************
 âœ… ã‚¤ãƒ™ãƒ³ãƒˆ
**************************************************************/
document.getElementById("btnNew").onclick=()=>openForm();
document.getElementById("btnCancel").onclick=()=>formModal.classList.add("hidden");
document.getElementById("q").oninput=refresh;
document.getElementById("pvClose").onclick=()=>pvModal.classList.add("hidden");
document.getElementById("pvEdit").onclick=()=>{pvModal.classList.add("hidden");openForm(true);}
document.getElementById("pvDel").onclick=async()=>{
 if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
 await tx('readwrite','entries').objectStore('entries').delete(previewItem.id);
 if(previewItem.fileId) await tx('readwrite','files').objectStore('files').delete(previewItem.fileId);
 pvModal.classList.add("hidden"); refresh();
}
document.getElementById("pvOpen").onclick=async()=>{
 const blob=await getFile(previewItem.fileId);
 const url=URL.createObjectURL(blob);
 window.open(url,"_blank");
}

/* Settings */
btnSettings.onclick=async()=>{
 fldApiKey.value=await metaGet("openai_key")||"";
 dlgSettings.classList.remove("hidden");
}
btnSaveSettings.onclick=async()=>{
 await metaPut("openai_key",fldApiKey.value.trim());
 dlgSettings.classList.add("hidden");
 toast("APIã‚­ãƒ¼ä¿å­˜");
}
btnCloseSettings.onclick=()=>dlgSettings.classList.add("hidden");

/* Folders */
btnFolders.onclick=()=>{
 folderList.innerHTML = folders.map(f=>`<li style="margin:.4rem 0">${f} <button class="pill del" data-f="${f}">å‰Šé™¤</button></li>`).join("");
 dlgFolders.classList.remove("hidden");
}
btnAddFolder.onclick=async()=>{
 const name=fldNewFolder.value.trim(); if(!name) return;
 if(!folders.includes(name)) folders.push(name);
 await metaPut("folders",folders);
 fldNewFolder.value="";
 btnFolders.onclick();
}
folderList.onclick=async e=>{
 const f=e.target.dataset.f; if(!f || f=="æœªåˆ†é¡")return;
 if(!confirm(`${f} ã‚’å‰Šé™¤?`))return;
 folders=folders.filter(x=>x!==f);
 await metaPut("folders",folders);
 btnFolders.onclick();refresh();
}
btnCloseFolders.onclick=()=>dlgFolders.classList.add("hidden");
</script>
</body>
</html>
